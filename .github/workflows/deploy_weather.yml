name: Generate Weather Data and Deploy Page

on:
  schedule:
    - cron: '0 0 * * *' # 每天早上 8 點執行
  workflow_dispatch: # 允許手動執行

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Generate weather data JSON
        env:
          CWA_API_KEY: ${{ secrets.CWA_API_KEY }}
          LOCATION_NAME: "臺北市"
        run: |
          python -c "
          import requests, os, json, sys
          from datetime import datetime
          
          CWA_API_KEY = os.environ.get('CWA_API_KEY')
          API_URL = 'https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001'
          LOCATION_NAME = os.environ.get('LOCATION_NAME')
          
          if not CWA_API_KEY:
              print('Error: CWA_API_KEY is missing')
              sys.exit(1)

          params = {'Authorization': CWA_API_KEY, 'format': 'JSON', 'locationName': LOCATION_NAME}
          response = requests.get(API_URL, params=params)
          data = response.json()
          
          if 'records' in data and data['records']['location']:
              loc = data['records']['location'][0]
              forecasts_temp = {}
              for elem in loc['weatherElement']:
                  for t in elem['time']:
                      start = t['startTime']
                      if start not in forecasts_temp: forecasts_temp[start] = {}
                      val = t['parameter']['parameterName']
                      name = elem['elementName']
                      if name == 'Wx': forecasts_temp[start]['Weather'] = val
                      elif name == 'PoP': forecasts_temp[start]['PoP'] = val + '%'
                      elif name == 'MinT': forecasts_temp[start]['MinT'] = val + '°C'
                      elif name == 'MaxT': forecasts_temp[start]['MaxT'] = val + '°C'
              
              res = {
                  'locationName': loc['locationName'],
                  'lastUpdated': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                  'forecasts': [
                      {'timeDisplay': datetime.strptime(s, '%Y-%m-%d %H:%M:%S').strftime('%m/%d %H時'), **v}
                      for s, v in sorted(forecasts_temp.items())
                  ]
              }
              with open('weather_data.json', 'w', encoding='utf-8') as f:
                  json.dump(res, f, ensure_ascii=False, indent=4)
              print('weather_data.json generated successfully.')
          else:
              print('Failed to get data'); sys.exit(1)
          "

      - name: Commit and Push JSON
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update weather data"
          file_pattern: 'weather_data.json'

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
